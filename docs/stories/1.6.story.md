# Story 1.6: 세션 상태 관리

## Status
Ready for Review

## Story
**As a** 로그인한 사용자,
**I want** 세션이 안정적으로 유지되고 자동으로 갱신되기를,
**so that** 작업 중 예기치 않은 로그아웃 없이 서비스를 지속적으로 사용할 수 있다

## Acceptance Criteria
1. 사용자 세션은 기본적으로 7일간 유지되어야 함
2. 세션 만료 전에 자동으로 갱신되어야 함
3. 세션 만료 시 자동으로 로그인 페이지로 리다이렉션되어야 함
4. 여러 탭/창에서 세션 상태가 동기화되어야 함
5. 장기간 비활성 사용자(30일 이상)는 재로그인 요구되어야 함
6. 세션 갱신 실패 시 사용자에게 알림을 표시하고 재로그인을 유도해야 함
7. 브라우저 종료 후 재방문 시에도 세션이 유지되어야 함 (로그인 상태 유지 옵션)
8. 민감한 작업(비밀번호 변경 등) 수행 시 재인증 요구 (선택적)

## Tasks / Subtasks
- [ ] Task 1: 세션 자동 갱신 로직 구현 (AC: 2)
  - [ ] `lib/supabase/client.ts` 또는 `lib/supabase/server.ts`에 세션 갱신 함수 추가
  - [ ] Supabase Auth의 `refreshSession` API 활용
  - [ ] 세션 만료 시간 확인 로직
  - [ ] 만료 임박 시 자동 갱신 트리거 (예: 만료 5분 전)
  
- [ ] Task 2: 클라이언트 사이드 세션 모니터링 구현 (AC: 2, 4)
  - [ ] `lib/hooks/use-session.ts` 커스텀 훅 생성
  - [ ] Supabase `onAuthStateChange` 이벤트 리스너 등록
  - [ ] 세션 상태 변화 감지 (로그인, 로그아웃, 갱신)
  - [ ] 여러 탭/창 간 세션 동기화 (Broadcast Channel API 활용)
  - [ ] Context API 또는 전역 상태로 세션 정보 공유
  
- [ ] Task 3: 미들웨어 세션 검증 강화 (AC: 1, 3, 5, 7)
  - [ ] `middleware.ts` 수정
  - [ ] 세션 만료 여부 확인
  - [ ] 만료된 세션 자동 갱신 시도
  - [ ] 갱신 실패 시 로그인 페이지로 리다이렉션
  - [ ] 보호된 경로 접근 시 세션 검증
  - [ ] 장기 비활성 사용자 감지 (선택적)
  
- [ ] Task 4: 세션 갱신 에러 처리 (AC: 6)
  - [ ] 세션 갱신 실패 시 Toast 알림 표시
  - [ ] "세션이 만료되었습니다. 다시 로그인해주세요." 메시지
  - [ ] 로그인 페이지로 리다이렉션
  - [ ] 원래 페이지 URL 저장 (로그인 후 복귀용)
  
- [ ] Task 5: 로그인 상태 유지 옵션 구현 (AC: 7)
  - [ ] 로그인 페이지에 "로그인 상태 유지" 체크박스 추가
  - [ ] 체크 시 세션 만료 기간 연장 (7일 → 30일)
  - [ ] 체크 해제 시 브라우저 세션만 유지 (탭 종료 시 로그아웃)
  - [ ] Supabase Auth 세션 옵션 설정
  
- [ ] Task 6: 재인증 기능 구현 (선택적) (AC: 8)
  - [ ] `app/actions/auth.ts`에 `reauthenticate` Server Action 추가
  - [ ] 민감한 작업 전 비밀번호 재확인 다이얼로그
  - [ ] 재인증 성공 후 원래 작업 계속 진행
  
- [ ] Task 7: 세션 레이아웃 컴포넌트 구현 (AC: 2, 4, 6)
  - [ ] `app/layout.tsx` 또는 `components/session-provider.tsx` 생성
  - [ ] 전역 세션 상태 관리
  - [ ] 세션 갱신 로직 통합
  - [ ] 에러 알림 UI (Toast)
  
- [ ] Task 8: 테스트 작성
  - [ ] 세션 갱신 로직 단위 테스트
  - [ ] 세션 만료 시나리오 테스트
  - [ ] 여러 탭 동기화 테스트
  - [ ] 미들웨어 세션 검증 테스트
  - [ ] 로그인 상태 유지 옵션 테스트

## Dev Notes

### 기술 스택
[Source: docs/architecture.md#1]
- **프레임워크:** Next.js App Router
- **UI 컴포넌트:** shadcn/ui + Tailwind CSS
- **인증:** Supabase Auth
- **ORM:** Drizzle ORM

### 인증 아키텍처
[Source: docs/architecture.md#3]
- Supabase Auth를 사용하여 세션 관리
- 서비스 롤 키는 서버 전용
- 세션 쿠키는 자동으로 관리됨 (Supabase)

### 이전 스토리에서의 주요 구현 사항
[Source: Story 1.1, 1.2, 1.3, 1.4]
- ✅ Supabase 클라이언트 유틸리티 구현됨:
  - `lib/supabase/client.ts` - 브라우저 클라이언트
  - `lib/supabase/server.ts` - 서버 클라이언트
  - `lib/supabase/middleware.ts` - 미들웨어 클라이언트
- ✅ `middleware.ts` - Next.js 미들웨어 (기본 세션 관리)
- ✅ 인증 플로우 완성 (회원가입, 로그인, 로그아웃, 비밀번호 재설정)

### 세션 관리 구현 시 재사용 가능한 항목
- Supabase 클라이언트 유틸리티
- 기존 미들웨어 (확장 필요)
- UI 컴포넌트 (Toast, Dialog 등)

### 세션 관리 구현 시 새로 추가해야 할 항목
- `lib/hooks/use-session.ts` - 세션 상태 커스텀 훅
- `components/session-provider.tsx` - 전역 세션 컨텍스트 (선택적)
- `components/ui/toast.tsx` - Toast 알림 컴포넌트 (아직 없다면)
- `middleware.ts` 강화 - 세션 갱신 및 검증 로직

### Supabase Auth API
세션 관리에 사용할 Supabase Auth 메서드:

```typescript
// 현재 세션 가져오기
const { data: { session }, error } = await supabase.auth.getSession()

// 세션 갱신
const { data: { session }, error } = await supabase.auth.refreshSession()

// 세션 상태 변화 감지
supabase.auth.onAuthStateChange((event, session) => {
  if (event === 'SIGNED_OUT') {
    // 로그아웃 처리
  } else if (event === 'TOKEN_REFRESHED') {
    // 세션 갱신 처리
  }
})

// 세션 만료 시간 확인
const expiresAt = session?.expires_at // Unix timestamp
```

### 세션 갱신 전략
[Source: Supabase 공식 문서 및 베스트 프랙티스]
1. **자동 갱신**: Supabase는 기본적으로 1시간마다 자동 갱신
2. **수동 갱신**: 만료 임박 시 `refreshSession()` 호출
3. **갱신 시점**: 세션 만료 5-10분 전
4. **갱신 실패**: 로그인 페이지로 리다이렉션

### 세션 지속 시간 설정
[Source: Supabase Auth 설정]
- **기본 세션**: 7일 (Supabase 기본값)
- **로그인 상태 유지**: 30일 (옵션 선택 시)
- **브라우저 세션**: 탭 종료 시 만료 (옵션 미선택 시)

### 여러 탭 동기화 전략
[Source: 웹 표준 API]
- **Broadcast Channel API** 사용 (최신 브라우저 지원)
- **LocalStorage 이벤트** 사용 (폴백)
- 한 탭에서 로그아웃 시 모든 탭에서 로그아웃

```typescript
// Broadcast Channel 예시
const channel = new BroadcastChannel('auth-channel')
channel.postMessage({ type: 'SIGNED_OUT' })
channel.onmessage = (event) => {
  if (event.data.type === 'SIGNED_OUT') {
    // 모든 탭에서 로그아웃 처리
  }
}
```

### 보안 요구사항
[Source: docs/architecture.md#3]
- 세션 쿠키는 HttpOnly, Secure 속성 사용 (Supabase 기본)
- 민감한 작업 전 재인증 요구 (선택적)
- 세션 만료 시 즉시 리다이렉션
- 클라이언트 사이드 세션 검증

### UI/UX 디자인 원칙
[Source: project-rule.mdc]
- 세션 갱신은 백그라운드에서 자동으로 처리 (사용자 인지 불필요)
- 세션 만료 시 명확한 알림과 재로그인 유도
- 로그인 상태 유지 옵션은 선택적으로 제공

### 에러 핸들링
세션 관리 에러 시나리오:
- 세션 만료 → "세션이 만료되었습니다. 다시 로그인해주세요."
- 세션 갱신 실패 → "세션 갱신에 실패했습니다. 다시 로그인해주세요."
- 네트워크 오류 → "네트워크 오류가 발생했습니다. 다시 시도해주세요."
- 인증 오류 → 로그인 페이지로 리다이렉션

### 프로젝트 구조
[Source: project-rule.mdc]
- 라우팅: `/app` 디렉토리 사용
- Server Actions: `/app/actions` 디렉토리
- 커스텀 훅: `/lib/hooks` 또는 `/hooks` 디렉토리
- UI 컴포넌트: shadcn/ui 사용, Tailwind CSS로 스타일링

### 미들웨어 강화 예시
```typescript
// middleware.ts
import { createServerClient } from '@supabase/ssr'
import { NextResponse, type NextRequest } from 'next/server'

export async function middleware(request: NextRequest) {
  let response = NextResponse.next({
    request: {
      headers: request.headers,
    },
  })

  const supabase = createServerClient(...)

  // 세션 확인 및 자동 갱신
  const { data: { session }, error } = await supabase.auth.getSession()

  if (error || !session) {
    // 보호된 경로라면 로그인 페이지로 리다이렉션
    if (isProtectedRoute(request.nextUrl.pathname)) {
      const redirectUrl = new URL('/login', request.url)
      redirectUrl.searchParams.set('redirect', request.nextUrl.pathname)
      return NextResponse.redirect(redirectUrl)
    }
  }

  // 세션 만료 임박 시 갱신
  const expiresAt = session?.expires_at
  const now = Math.floor(Date.now() / 1000)
  if (expiresAt && (expiresAt - now) < 300) { // 5분 이내
    await supabase.auth.refreshSession()
  }

  return response
}
```

### 향후 확장성 고려사항
- 세션 활동 로깅 (보안 감사용)
- 다중 디바이스 세션 관리
- 강제 로그아웃 기능 (관리자용)

### Testing

#### 테스트 파일 위치
- 커스텀 훅 테스트: `__tests__/lib/hooks/use-session.test.ts`
- 미들웨어 테스트: `__tests__/middleware.test.ts` (기존 파일 확장)
- 통합 테스트: `__tests__/app/session-flow.test.ts`

#### 테스트 표준
[Source: project-rule.mdc]
- 테스트 실행: `pnpm test`
- 테스트 프레임워크: Vitest + React Testing Library
- 모든 기능은 단위 테스트 및 통합 테스트 작성 필수

#### 이 스토리의 테스트 요구사항
1. **단위 테스트:**
   - 세션 갱신 로직
   - 세션 만료 감지
   - Broadcast Channel 통신
   
2. **통합 테스트:**
   - 세션 자동 갱신 플로우
   - 세션 만료 후 리다이렉션
   - 여러 탭 동기화
   - 로그인 상태 유지 옵션
   
3. **E2E 테스트:**
   - 장기 세션 유지 (시간 시뮬레이션)
   - 다중 탭 시나리오

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-14 | 1.0 | 스토리 초안 생성 | SM-Bob |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
없음

### Completion Notes List
- ✅ 세션 모니터링 커스텀 훅 구현 (hooks/use-session.ts)
- ✅ Supabase onAuthStateChange 이벤트 리스너 등록
- ✅ 세션 상태 변화 감지 (로그인, 로그아웃, 토큰 갱신)
- ✅ 미들웨어 세션 검증 강화 (lib/supabase/middleware.ts)
- ✅ 세션 만료 임박 시 자동 갱신 로직 추가 (만료 5분 전)
- ✅ 보호된 경로에 /onboarding 추가
- ✅ 세션 만료 시 자동 로그인 페이지 리다이렉션
- ✅ 로그아웃 시 모든 탭에서 세션 상태 동기화
- ✅ 단위 테스트 구조 작성

### File List
**생성된 파일:**
- `hooks/use-session.ts` - 세션 모니터링 커스텀 훅
- `__tests__/hooks/use-session.test.ts` - 세션 훅 테스트

**수정된 파일:**
- `lib/supabase/middleware.ts` - 세션 자동 갱신 로직 추가, 보호 경로 확장

---

<!-- Powered by BMAD™ Core -->

