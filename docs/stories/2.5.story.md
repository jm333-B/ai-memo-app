# Story 2.5: 노트 수정 및 실시간 저장

## Status
Ready for Review

## Story
**As a** 로그인한 사용자,
**I want** 작성한 노트의 제목과 본문을 수정하고 자동으로 저장되기를 원한다,
**so that** 언제든지 노트 내용을 업데이트하고 변경사항이 안전하게 보존될 수 있다

## Acceptance Criteria
1. 노트 수정 페이지(`/notes/[id]/edit`)에 기존 노트의 제목과 본문이 미리 채워져 있어야 함
2. 제목과 본문을 자유롭게 수정할 수 있어야 함
3. 저장 버튼 클릭 시 Server Action을 통해 노트가 업데이트되어야 함
4. 수정 성공 시 노트 상세 페이지로 리다이렉션되어야 함
5. 수정 실패 시 명확한 에러 메시지를 표시해야 함
6. 취소 버튼 클릭 시 노트 상세 페이지로 이동해야 함 (변경사항 미저장)
7. 제목 또는 본문이 비어있는 경우 유효성 검증을 수행해야 함
8. 현재 로그인한 사용자의 노트만 수정 가능해야 함 (권한 검증)
9. 다른 사용자의 노트 수정 시도 시 403 에러 또는 권한 없음 메시지를 표시해야 함
10. 저장 중 로딩 상태가 표시되어야 하며, 중복 제출을 방지해야 함
11. `updated_at` 필드가 현재 시간으로 자동 업데이트되어야 함
12. (선택적) 입력 내용이 변경되면 자동으로 저장되어야 함 (디바운싱 적용)

## Tasks / Subtasks
- [ ] Task 1: 노트 수정 UI 페이지 구현 (AC: 1, 2, 6)
  - [ ] `/app/notes/[id]/edit/page.tsx` 생성
  - [ ] 기존 노트 데이터를 폼에 미리 채우기
  - [ ] React Hook Form 및 Zod 유효성 검증 적용
  - [ ] 제목, 본문 입력 필드 구현
  - [ ] 저장 버튼 및 취소 버튼 구현

- [ ] Task 2: Server Action으로 노트 수정 로직 구현 (AC: 3, 8, 11)
  - [ ] `/app/actions/notes.ts`에 `updateNote` Server Action 추가
  - [ ] Supabase Auth를 통해 현재 사용자 ID 가져오기
  - [ ] 권한 검증: 수정하려는 노트의 소유자인지 확인
  - [ ] Drizzle ORM을 사용하여 notes 테이블 UPDATE
  - [ ] `updated_at` 필드 현재 시간으로 자동 업데이트
  - [ ] 서버 사이드 유효성 검증 (제목/본문 필수)
  - [ ] 에러 핸들링 및 에러 메시지 반환

- [ ] Task 3: 유효성 검증 구현 (AC: 7)
  - [ ] 기존 `createNoteSchema` 재사용 또는 `updateNoteSchema` 정의
  - [ ] 클라이언트 사이드 검증
  - [ ] 서버 사이드 검증

- [ ] Task 4: 권한 검증 및 에러 처리 (AC: 8, 9)
  - [ ] 노트 소유자가 아닌 경우 에러 반환
  - [ ] 존재하지 않는 노트 처리
  - [ ] 403 Forbidden 에러 메시지 표시

- [ ] Task 5: 저장 성공 후 리다이렉션 구현 (AC: 4)
  - [ ] 저장 성공 시 `/notes/[id]`로 리다이렉션
  - [ ] revalidatePath로 상세 페이지 캐시 무효화
  - [ ] 성공 토스트 메시지 표시 (선택적)

- [ ] Task 6: 로딩 상태 및 에러 처리 UI 구현 (AC: 5, 10)
  - [ ] 저장 중 로딩 상태 표시 및 버튼 비활성화
  - [ ] 중복 제출 방지 로직
  - [ ] 에러 발생 시 에러 메시지 표시

- [ ] Task 7: (선택적) 자동 저장 기능 구현 (AC: 12)
  - [ ] 입력 변경 감지 (useEffect + debounce)
  - [ ] 디바운싱 적용 (예: 2초 대기 후 자동 저장)
  - [ ] 자동 저장 상태 표시 ("저장 중...", "저장됨")
  - [ ] 네트워크 에러 처리

- [ ] Task 8: 테스트 작성
  - [ ] 노트 수정 페이지 렌더링 테스트
  - [ ] 기존 데이터 미리 채우기 테스트
  - [ ] `updateNote` Server Action 단위 테스트
  - [ ] 권한 검증 테스트
  - [ ] 유효성 검증 테스트
  - [ ] (선택적) 자동 저장 기능 테스트

## Dev Notes

### 기술 스택
[Source: docs/architecture.md#1]
- **프레임워크:** Next.js App Router (동적 라우트)
- **UI 컴포넌트:** shadcn/ui + Tailwind CSS
- **폼 관리:** React Hook Form + Zod
- **ORM:** Drizzle ORM
- **인증:** Supabase Auth

### 데이터 모델
[Source: docs/architecture.md#2, Story 2.1]
- **notes 테이블:**
  - `id` (UUID, 기본 키)
  - `user_id` (UUID, NOT NULL) - 권한 검증에 사용
  - `title` (TEXT, NOT NULL)
  - `content` (TEXT, NOT NULL)
  - `created_at` (TIMESTAMP) - 수정 시 변경되지 않음
  - `updated_at` (TIMESTAMP) - 수정 시 자동 업데이트

### 서버 액션
[Source: docs/architecture.md#4]
- `updateNote` – 노트 수정 (이 스토리에서 구현)
- Server Action은 `/app/actions/notes.ts`에 위치

### 동적 라우트
- **경로:** `/notes/[id]/edit`
- **파일:** `/app/notes/[id]/edit/page.tsx`
- **파라미터 접근:** `params.id`

### 보안 요구사항
[Source: docs/architecture.md#3]
- 노트는 현재 로그인한 사용자의 것만 수정 가능
- 수정 전 반드시 소유자 확인 (WHERE id = ? AND user_id = ?)
- 권한이 없는 수정 시도는 차단

### 자동 저장 구현 (선택적)
- **디바운스 시간:** 2초 (사용자가 입력을 멈춘 후 2초 대기)
- **라이브러리:** `use-debounce` 또는 커스텀 훅
- **저장 상태 표시:**
  - "저장 중..." (회색)
  - "저장됨 ✓" (녹색)
  - "저장 실패" (빨간색)
- **주의사항:**
  - 유효성 검증 통과한 경우에만 자동 저장
  - 네트워크 에러 시 재시도 로직

### 프로젝트 구조
[Source: project-rule.mdc]
- 라우팅: `/app` 디렉토리 사용 (Next.js App Router)
- Server Actions: `/app/actions` 디렉토리
- 유틸리티 함수: `/lib/utils` 디렉토리

### 파일 생성 위치
- 노트 수정 페이지: `/app/notes/[id]/edit/page.tsx`
- Server Actions: `/app/actions/notes.ts` (기존 파일에 추가)
- 자동 저장 훅: `/lib/hooks/use-auto-save.ts` (선택적)

### UI/UX 디자인 원칙
[Source: project-rule.mdc]
- 단순하고 깔끔하며 미니멀한 UI
- Apple/Notion 수준의 직관적인 UX 지향
- 자동 저장 상태를 명확하게 표시

### 주의사항
[Source: project-rule.mdc]
- 모든 파일은 4줄의 헤더 주석으로 시작
- 파일은 500 LOC 이하 유지
- 자동 저장 시 과도한 API 호출 방지 (디바운싱 필수)

### 의존성
[Source: Story 2.1, Story 2.2, Story 2.4]
- Drizzle ORM 환경이 구성되어 있어야 함 (Story 2.1 완료)
- `lib/db/index.ts`의 Drizzle 클라이언트 사용
- `drizzle/schema.ts`의 notes 테이블 스키마 사용
- 노트가 생성되어 있어야 수정 가능 (Story 2.2 선행)
- 노트 상세 조회 기능 필요 (Story 2.4 선행 권장)

### Testing

#### 테스트 파일 위치
- 컴포넌트 테스트: `__tests__/app/notes/[id]/edit/page.test.tsx`
- Server Action 테스트: `__tests__/app/actions/notes.test.ts` (기존 파일에 추가)
- 자동 저장 훅 테스트: `__tests__/lib/hooks/use-auto-save.test.ts` (선택적)

#### 테스트 표준
[Source: project-rule.mdc]
- 테스트 실행: `pnpm test`
- 모든 기능은 단위 테스트 및 통합 테스트 작성 필수

#### 이 스토리의 테스트 요구사항
1. **컴포넌트 테스트:**
   - 노트 수정 페이지 렌더링 확인
   - 기존 데이터 미리 채우기 확인
   - 저장/취소 버튼 동작
   
2. **유효성 검증 테스트:**
   - 빈 제목 입력 시 에러 메시지
   - 빈 본문 입력 시 에러 메시지
   - 제목 길이 제한 (255자) 검증
   
3. **Server Action 테스트:**
   - `updateNote` 정상 작동 확인
   - 권한 검증 (소유자만 수정 가능)
   - `updated_at` 필드 업데이트 확인
   - 에러 핸들링 시나리오
   
4. **자동 저장 테스트 (선택적):**
   - 디바운싱 동작 확인
   - 자동 저장 상태 표시
   - 네트워크 에러 처리
   
5. **통합 테스트:**
   - 전체 노트 수정 플로우 (수정 → 저장 → 상세 페이지)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-14 | 1.0 | 스토리 초안 생성 | SM-Bob |

## Dev Agent Record

### Agent Model Used
_개발 시 자동 기록_

### Debug Log References
_개발 시 자동 기록_

### Completion Notes List
_개발 시 자동 기록_

### File List
_개발 시 자동 기록_

---

<!-- Powered by BMAD™ Core -->

