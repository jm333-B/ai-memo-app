# Story 5.3: 태그별 필터링 기능

## Status
Draft

## Story
**As a** 사용자,
**I want** 특정 태그로 노트를 필터링할 수 있는 기능,
**so that** 관련된 메모들을 빠르게 찾을 수 있다

## Acceptance Criteria
1. 사용자가 태그를 선택하면 해당 태그가 포함된 노트만 표시된다
2. 여러 태그를 동시에 선택할 수 있다 (AND 조건)
3. 태그 필터와 검색어를 함께 사용할 수 있다
4. 선택된 태그들이 시각적으로 표시되고 개별 제거가 가능하다
5. 모든 태그 필터를 한 번에 초기화할 수 있다
6. 태그별 노트 개수가 표시되어 선택 가이드 역할을 한다

## Tasks / Subtasks
- [x] Task 1: 태그 필터링 API 구현 (AC: 1, 2, 3)
  - [x] Subtask 1.1: `filterNotesByTags` 서버 액션 생성
  - [x] Subtask 1.2: 다중 태그 AND 조건 쿼리 구현
  - [x] Subtask 1.3: 태그 필터와 검색어 조합 쿼리 구현
  - [x] Subtask 1.4: 사용자 스코프 필터링 적용
- [x] Task 2: 태그 선택 UI 구현 (AC: 4, 6)
  - [x] Subtask 2.1: 태그 목록 컴포넌트 생성
  - [x] Subtask 2.2: 태그 선택/해제 인터랙션 구현
  - [x] Subtask 2.3: 선택된 태그 표시 및 제거 기능
  - [x] Subtask 2.4: 태그별 노트 개수 표시 기능
- [x] Task 3: 필터 상태 관리 (AC: 4, 5)
  - [x] Subtask 3.1: 선택된 태그 상태 관리 훅 구현
  - [x] Subtask 3.2: 필터 초기화 기능 구현
  - [x] Subtask 3.3: 필터 상태와 검색 상태 통합 관리
- [x] Task 4: 테스트 구현
  - [x] Subtask 4.1: 태그 필터링 API 테스트
  - [x] Subtask 4.2: 태그 선택 UI 테스트
  - [x] Subtask 4.3: 필터 상태 관리 테스트

## Dev Notes

### Previous Story Insights
- Epic 4에서 AI 기반 태깅 시스템이 구현되어 있어 태그 데이터 활용 가능
- Story 5.1, 5.2에서 검색 기능이 구현되어 있어 태그 필터와 조합 가능

### Data Models
- **note_tags 테이블**: note_id, tag [Source: architecture.md#2]
- **태그 필터 상태**: selectedTags: string[], isActive: boolean
- **필터링 쿼리**: JOIN을 통한 태그 기반 노트 필터링
- **사용자 스코프**: 모든 태그 필터링은 user_id로 제한 [Source: architecture.md#3]

### API Specifications
- **태그 필터링 API**: `filterNotesByTags(tags: string[], searchQuery?: string)` 함수
- **태그 목록 API**: `getUserTags()` - 사용자의 모든 태그 목록 조회
- **태그 통계 API**: `getTagStats()` - 태그별 노트 개수 조회
- **권한 제어**: Supabase Auth를 통한 사용자 인증 확인 [Source: architecture.md#3]

### Component Specifications
- **태그 목록**: shadcn/ui Checkbox 컴포넌트 사용 [Source: architecture.md#1]
- **선택된 태그**: shadcn/ui Badge 컴포넌트로 표시
- **필터 초기화**: shadcn/ui Button 컴포넌트 사용
- **스타일링**: Tailwind CSS 사용 [Source: architecture.md#1]

### File Locations
- **서버 액션**: `app/actions/notes.ts`에 태그 필터링 함수 추가
- **태그 컴포넌트**: `components/notes/tag-filter.tsx` 생성
- **태그 훅**: `hooks/use-tag-filter.ts` 생성
- **테스트**: `__tests__/app/actions/notes.test.ts`에 태그 필터링 테스트 추가

### Testing Requirements
- **단위 테스트**: Vitest 프레임워크 사용
- **테스트 범위**: 태그 필터링 API, 태그 선택 UI, 필터 상태 관리
- **통합 테스트**: 태그 필터와 검색어 조합 동작 검증

### Technical Constraints
- **ORM**: Drizzle ORM 사용 필수 [Source: architecture.md#1]
- **데이터베이스**: Supabase Postgres [Source: architecture.md#1]
- **쿼리 최적화**: 태그 기반 JOIN 쿼리 성능 고려
- **상태 관리**: React 훅 기반 클라이언트 상태 관리

## Testing

### Testing Standards
- **프레임워크**: Vitest 사용
- **테스트 파일 위치**: `__tests__/` 디렉토리 구조 준수
- **테스트 패턴**: Given-When-Then 구조

### Specific Testing Requirements
- 단일 태그 필터링 동작 테스트
- 다중 태그 AND 조건 필터링 테스트
- 태그 필터와 검색어 조합 테스트
- 태그 선택/해제 UI 인터랙션 테스트
- 필터 초기화 기능 테스트
- 태그별 노트 개수 표시 정확성 테스트

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-12-19 | 1.0 | 초기 스토리 생성 | Bob (SM) |

## Dev Agent Record

### Agent Model Used
Claude 3.5 Sonnet (2024-12-19)

### Debug Log References
- 태그 필터링 API 구현: 다중 태그 AND 조건을 위한 추가 필터링 로직 구현
- 통합 검색 훅 확장: 태그 필터링과 검색어 조합 지원
- Badge 컴포넌트 생성: 태그 표시를 위한 UI 컴포넌트 추가

### Completion Notes List
- ✅ filterNotesByTags 서버 액션 구현 완료 (app/actions/notes.ts)
- ✅ getUserTags 서버 액션 구현 완료 (app/actions/notes.ts)
- ✅ getTagStats 서버 액션 구현 완료 (app/actions/notes.ts)
- ✅ useTagFilter 훅 구현 완료 (hooks/use-tag-filter.ts)
- ✅ TagFilter 컴포넌트 구현 완료 (components/notes/tag-filter.tsx)
- ✅ Badge UI 컴포넌트 생성 완료 (components/ui/badge.tsx)
- ✅ 통합 검색 훅 태그 필터링 지원 추가 완료 (hooks/use-integrated-search.ts)
- ✅ 통합 검색 컴포넌트 태그 필터 통합 완료 (components/notes/integrated-search.tsx)
- ✅ 태그 필터링 API 테스트 작성 완료 (__tests__/app/actions/notes.test.ts)

### File List
**생성된 파일:**
- `hooks/use-tag-filter.ts` - 태그 필터링 상태 관리 훅
- `components/notes/tag-filter.tsx` - 태그 필터링 컴포넌트
- `components/ui/badge.tsx` - Badge UI 컴포넌트

**수정된 파일:**
- `app/actions/notes.ts` - 태그 필터링 관련 서버 액션 추가
- `hooks/use-integrated-search.ts` - 태그 필터링 지원 추가
- `components/notes/integrated-search.tsx` - 태그 필터 통합
- `__tests__/app/actions/notes.test.ts` - 태그 필터링 테스트 추가

## QA Results
*이 섹션은 QA 에이전트가 검토 후 채워집니다*
