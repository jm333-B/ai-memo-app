# Story 4.1: Gemini API 설정 및 연동

## Status
Ready for Review

## Story
**As a** 시스템 관리자,
**I want** Google Gemini API를 프로젝트에 안전하게 연동하고,
**so that** 노트 요약 및 태깅 기능을 위한 AI 기반 서비스를 사용할 수 있다

## Acceptance Criteria
1. Google Gemini API 키를 환경 변수로 설정할 수 있어야 함
2. API 키는 서버 사이드에서만 접근 가능해야 함 (클라이언트 노출 금지)
3. Gemini API와의 연결을 검증하는 테스트 함수가 있어야 함
4. API 호출 실패 시 적절한 에러 핸들링이 되어야 함
5. 토큰 제한(8k 토큰) 관리 로직이 구현되어야 함
6. API 응답 시간이 10초를 초과하면 타임아웃 처리되어야 함
7. API 비용 최적화를 위한 무료 할당량 사용 설정이 되어야 함
8. API 연동 상태를 확인할 수 있는 헬스체크 함수가 있어야 함

## Tasks / Subtasks
- [x] Task 1: Google Gemini API 프로젝트 설정 (AC: 1)
  - [x] Google AI Studio에서 API 키 발급
  - [x] `.env.local`에 환경 변수 추가 (`GEMINI_API_KEY`)
  - [x] `.env.example` 파일에 환경 변수 템플릿 추가
  - [x] `.gitignore`에 `.env.local` 포함 확인

- [x] Task 2: Gemini SDK 설치 및 설정 (AC: 2, 7)
  - [x] `@google/genai` 패키지 설치 (`pnpm add @google/genai`)
  - [x] `/lib/ai/gemini-client.ts` 생성
  - [x] Gemini 클라이언트 초기화 함수 구현
  - [x] 최신 모델(`gemini-2.0-flash`) 설정
  - [x] 서버 전용 설정 확인 (클라이언트 접근 차단)

- [x] Task 3: 토큰 제한 관리 유틸리티 구현 (AC: 5)
  - [x] `/lib/ai/token-counter.ts` 생성
  - [x] 텍스트 길이 기반 토큰 추정 함수 구현
  - [x] 8k 토큰 제한 검증 함수 구현
  - [x] 토큰 초과 시 텍스트 자르기 함수 구현

- [x] Task 4: API 호출 래퍼 함수 구현 (AC: 4, 6, 8)
  - [x] `/lib/ai/gemini-api.ts` 생성
  - [x] `callGeminiAPI` 함수 구현
  - [x] 타임아웃 설정 (10초)
  - [x] 에러 핸들링 및 재시도 로직
  - [x] API 응답 타입 정의
  - [x] 헬스체크 함수 구현 (`checkGeminiHealth`)

- [x] Task 5: Server Action 생성 (AC: 2, 3)
  - [x] `/app/actions/ai.ts` 생성
  - [x] `testGeminiConnection` Server Action 구현
  - [x] 사용자 인증 확인
  - [x] API 연결 테스트 및 결과 반환

- [x] Task 6: 에러 핸들링 구현 (AC: 4)
  - [x] `/lib/errors/ai-errors.ts` 생성
  - [x] `GeminiAPIError` 클래스 정의
  - [x] `GeminiTimeoutError` 클래스 정의
  - [x] `GeminiQuotaExceededError` 클래스 정의
  - [x] 에러 메시지 한글화

- [x] Task 7: 테스트 작성 (AC: 3, 8)
  - [x] 토큰 카운터 유틸리티 테스트
  - [x] API 래퍼 함수 테스트 (모킹)
  - [x] Server Action 테스트
  - [x] 에러 핸들링 테스트
  - [x] 타임아웃 테스트

## Dev Notes

### 기술 스택
[Source: docs/architecture.md#1, Context7: /googleapis/js-genai]
- **AI 모델:** Google Gemini API (요약/태깅)
- **프레임워크:** Next.js App Router (Server Actions)
- **SDK:** @google/genai (Google Gen AI SDK)
- **환경 변수 관리:** .env.local

### 보안 규칙
[Source: docs/architecture.md#3, project-rule.mdc]
- **클라이언트에서 직접 외부 API 호출 금지** → 서버사이드에서만 호출
- API 키는 환경 변수로 관리하고 클라이언트에 절대 노출 금지
- 모든 AI 관련 로직은 Server Action 또는 서버 컴포넌트에서만 실행

### Gemini API 설정
[Source: Context7: /googleapis/js-genai]

**패키지 설치:**
```bash
pnpm add @google/genai
```

**클라이언트 초기화:**
```typescript
// lib/ai/gemini-client.ts
import { GoogleGenAI } from '@google/genai';

const apiKey = process.env.GEMINI_API_KEY;
if (!apiKey) {
  throw new Error('GEMINI_API_KEY is not defined');
}

// GoogleGenAI 클라이언트 초기화
const genAI = new GoogleGenAI({ apiKey });

// 최신 모델 사용 (gemini-2.0-flash)
// Note: 모델은 호출 시점에 지정
export { genAI };
```

**대안: 환경 변수 자동 인식**
```typescript
// .env.local에 GOOGLE_API_KEY 또는 GEMINI_API_KEY 설정 시
const genAI = new GoogleGenAI({});  // 자동으로 GOOGLE_API_KEY 읽음
```

### 토큰 제한 관리
[Source: docs/epics/epic-4-ai-summarization-tagging.md#21]
- **제한:** 8k 토큰
- **추정 방식:** 한글 1자 ≈ 2토큰, 영문 1단어 ≈ 1.3토큰
- **초과 시:** 텍스트를 잘라서 제한 내로 조정

```typescript
// lib/ai/token-counter.ts
export function estimateTokens(text: string): number {
  // 간단한 추정: 문자 수 기반
  const koreanChars = (text.match(/[\u3131-\uD79D]/g) || []).length;
  const otherChars = text.length - koreanChars;
  return Math.ceil(koreanChars * 2 + otherChars * 0.5);
}

export function validateTokenLimit(text: string, limit = 8000): boolean {
  return estimateTokens(text) <= limit;
}

export function truncateToTokenLimit(text: string, limit = 8000): string {
  if (validateTokenLimit(text, limit)) return text;
  
  // 초과 시 단계적으로 자르기
  let truncated = text;
  while (!validateTokenLimit(truncated, limit) && truncated.length > 0) {
    truncated = truncated.slice(0, Math.floor(truncated.length * 0.9));
  }
  return truncated;
}
```

### API 호출 래퍼
[Source: Context7: /googleapis/js-genai]

```typescript
// lib/ai/gemini-api.ts
import { genAI } from './gemini-client';
import { GeminiAPIError, GeminiTimeoutError } from '@/lib/errors/ai-errors';

const TIMEOUT_MS = 10000; // 10초
const MODEL_NAME = 'gemini-2.0-flash'; // 최신 모델

export async function callGeminiAPI(prompt: string): Promise<string> {
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), TIMEOUT_MS);

  try {
    // 모델 가져오기
    const model = genAI.models.get(MODEL_NAME);
    
    // 컨텐츠 생성
    const result = await model.generateContent({
      contents: [{ role: 'user', parts: [{ text: prompt }] }],
      config: {
        maxOutputTokens: 1024,
        temperature: 0.7,
      }
    });
    
    clearTimeout(timeoutId);
    
    // 응답 텍스트 추출
    const response = result.response;
    return response.text();
  } catch (error: any) {
    clearTimeout(timeoutId);
    
    if (error.name === 'AbortError') {
      throw new GeminiTimeoutError('API 호출이 시간 초과되었습니다');
    }
    
    throw new GeminiAPIError(error.message || 'Gemini API 호출 실패');
  }
}

export async function checkGeminiHealth(): Promise<boolean> {
  try {
    await callGeminiAPI('테스트');
    return true;
  } catch {
    return false;
  }
}
```

### Server Action
```typescript
// app/actions/ai.ts
'use server';

import { createClient } from '@/lib/supabase/server';
import { checkGeminiHealth } from '@/lib/ai/gemini-api';

export async function testGeminiConnection() {
  // 인증 확인
  const supabase = await createClient();
  const { data: { user }, error } = await supabase.auth.getUser();
  
  if (error || !user) {
    return { success: false, error: 'Unauthorized' };
  }

  // API 연결 테스트
  try {
    const isHealthy = await checkGeminiHealth();
    return { success: isHealthy };
  } catch (error) {
    return { success: false, error: error.message };
  }
}
```

### 프로젝트 구조
[Source: project layout]
```
/lib/ai/
  ├── gemini-client.ts      # Gemini 클라이언트 초기화
  ├── gemini-api.ts         # API 호출 래퍼
  └── token-counter.ts      # 토큰 제한 관리

/lib/errors/
  └── ai-errors.ts          # AI 관련 에러 클래스

/app/actions/
  └── ai.ts                 # AI 관련 Server Actions

/__tests__/lib/ai/
  ├── gemini-api.test.ts
  └── token-counter.test.ts
```

### 에러 클래스 정의
```typescript
// lib/errors/ai-errors.ts
export class GeminiAPIError extends Error {
  constructor(message: string) {
    super(message);
    this.name = 'GeminiAPIError';
  }
}

export class GeminiTimeoutError extends GeminiAPIError {
  constructor(message: string) {
    super(message);
    this.name = 'GeminiTimeoutError';
  }
}

export class GeminiQuotaExceededError extends GeminiAPIError {
  constructor(message: string) {
    super(message);
    this.name = 'GeminiQuotaExceededError';
  }
}
```

### 환경 변수 설정
[Source: Context7: /googleapis/js-genai]

```bash
# .env.local (실제 값)
GEMINI_API_KEY=your_actual_api_key_here

# 또는 SDK 기본 환경 변수 사용 (선택)
GOOGLE_API_KEY=your_actual_api_key_here

# .env.example (템플릿)
GEMINI_API_KEY=your_gemini_api_key
```

**Note:** `@google/genai` SDK는 기본적으로 `GOOGLE_API_KEY` 환경 변수를 자동으로 인식합니다. 이 프로젝트에서는 명시성을 위해 `GEMINI_API_KEY`를 사용합니다.

### 모델 선택
[Source: docs/architecture.md#6, docs/epics/epic-4-ai-summarization-tagging.md#21]
- **사용 모델:** `gemini-2.0-flash` (최신 모델, 성능 향상)
- **토큰 제한:** 8k 토큰 (입력 텍스트 최적화)

### 참고: Gemini API 모델
[Source: Context7: /googleapis/js-genai]
- `gemini-1.5-pro`: 고품질, 느림, 비용 높음
- `gemini-1.5-flash`: 빠름, 비용 낮음 (구 버전)
- `gemini-2.0-flash`: 최신, 빠르고 성능 향상 ✅ (사용)

### SDK 주요 특징
- **통합 SDK:** Gemini Developer API와 Vertex AI 모두 지원
- **TypeScript 지원:** 완전한 타입 정의
- **모델 접근:** `genAI.models.get(modelName)` 방식
- **설정 옵션:** `GenerateContentConfig`로 세밀한 제어 가능

### 주의사항
[Source: project-rule.mdc]
- 모든 파일은 4줄의 헤더 주석으로 시작
- 파일은 500 LOC 이하 유지
- 에러 메시지는 한글로 작성
- API 키는 절대 클라이언트에 노출 금지

### 의존성
- 없음 (이 스토리는 Epic 4의 첫 번째 스토리)

### Testing

#### 테스트 파일 위치
- 토큰 카운터 테스트: `__tests__/lib/ai/token-counter.test.ts`
- API 래퍼 테스트: `__tests__/lib/ai/gemini-api.test.ts`
- Server Action 테스트: `__tests__/app/actions/ai.test.ts`

#### 테스트 표준
[Source: project-rule.mdc]
- 테스트 실행: `pnpm test`
- 모든 기능은 단위 테스트 필수

#### 이 스토리의 테스트 요구사항
1. **토큰 카운터 테스트:**
   - `estimateTokens` 정확도 확인
   - `validateTokenLimit` 동작 확인
   - `truncateToTokenLimit` 동작 확인

2. **API 래퍼 테스트:**
   - Gemini API 모킹
   - 정상 응답 처리 확인
   - 타임아웃 처리 확인
   - 에러 핸들링 확인
   - 헬스체크 함수 확인

3. **Server Action 테스트:**
   - 인증 확인 로직 테스트
   - API 연결 테스트 동작 확인

4. **에러 클래스 테스트:**
   - 각 에러 클래스 인스턴스화 확인
   - 에러 메시지 확인

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-14 | 1.0 | 스토리 초안 생성 | SM-Bob |
| 2025-10-14 | 1.1 | @google/genai 패키지로 변경, Context7 기반 업데이트 | SM-Bob |
| 2025-10-14 | 2.0 | 스토리 구현 완료, 모든 테스트 통과 | Dev-James |
| 2025-10-14 | 2.1 | AI 모델을 gemini-2.0-flash로 변경 | SM-Bob |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (Cursor AI - Dev Agent James)

### Debug Log References
없음 - 모든 구현이 첫 시도에 성공

### Completion Notes List
- @google/genai 패키지 (v1.24.0) 설치 완료
- 모든 AI 관련 파일 생성 및 구현 완료
- 총 28개 테스트 작성 및 통과 (token-counter: 14, gemini-api: 5, ai-errors: 5, ai server action: 4)
- .env.example 파일 생성하여 환경 변수 템플릿 제공
- 서버 사이드 전용 구현으로 보안 요구사항 충족
- 타임아웃 10초, 토큰 제한 8k 설정 완료
- AI 모델을 gemini-2.0-flash로 업데이트 (최신 버전)

### File List
#### 생성된 파일
- `.env.example` - 환경 변수 템플릿
- `lib/ai/gemini-client.ts` - Gemini 클라이언트 초기화
- `lib/ai/gemini-api.ts` - API 호출 래퍼 함수
- `lib/ai/token-counter.ts` - 토큰 제한 관리 유틸리티
- `lib/errors/ai-errors.ts` - AI 관련 에러 클래스
- `app/actions/ai.ts` - AI 관련 Server Actions
- `__tests__/lib/ai/token-counter.test.ts` - 토큰 카운터 테스트
- `__tests__/lib/ai/gemini-api.test.ts` - API 래퍼 테스트
- `__tests__/lib/errors/ai-errors.test.ts` - 에러 클래스 테스트
- `__tests__/app/actions/ai.test.ts` - Server Action 테스트

#### 수정된 파일
- `package.json` - @google/genai 패키지 추가
- `pnpm-lock.yaml` - 의존성 잠금 파일 업데이트
- `lib/ai/gemini-client.ts` - 모델을 gemini-2.0-flash로 변경

---

<!-- Powered by BMAD™ Core -->

