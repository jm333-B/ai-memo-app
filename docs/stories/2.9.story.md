# Story 2.9: 노트 작성 중 임시 저장

## Status
Draft

## Story
**As a** 로그인한 사용자,
**I want** 노트를 작성하는 중에 브라우저를 닫거나 실수로 페이지를 벗어나도 작성 중인 내용이 보존되기를 원한다,
**so that** 작성 중인 내용을 잃지 않고 나중에 다시 이어서 작성할 수 있다

## Acceptance Criteria
1. 노트 작성 페이지(`/notes/new`)에서 제목 또는 본문을 입력하면 자동으로 임시 저장되어야 함
2. 임시 저장은 브라우저의 `localStorage`에 저장되어야 함
3. 입력이 멈춘 후 1~2초(디바운스) 후에 자동 저장되어야 함
4. 임시 저장된 내용이 있을 경우, 페이지 재방문 시 자동으로 불러와야 함
5. 임시 저장된 내용을 불러올 때 사용자에게 알림을 표시해야 함 ("임시 저장된 내용을 불러왔습니다")
6. 노트를 성공적으로 저장한 후에는 임시 저장 데이터를 삭제해야 함
7. "임시 저장된 내용 삭제" 버튼을 제공하여 사용자가 수동으로 삭제할 수 있어야 함
8. 페이지를 벗어나려 할 때 저장하지 않은 변경사항이 있으면 확인 다이얼로그를 표시해야 함
9. 임시 저장 상태를 UI에 표시해야 함 ("임시 저장됨", "저장 중...")
10. 여러 노트를 작성 중일 경우를 대비하여 각 노트별로 임시 저장을 관리해야 함

## Tasks / Subtasks
- [ ] Task 1: localStorage 유틸리티 함수 구현 (AC: 2, 6, 10)
  - [ ] `/lib/utils/draft-storage.ts` 생성
  - [ ] `saveDraft(key, data)` - 임시 저장
  - [ ] `loadDraft(key)` - 임시 저장 불러오기
  - [ ] `deleteDraft(key)` - 임시 저장 삭제
  - [ ] `getAllDrafts()` - 모든 임시 저장 목록 (선택적)
  - [ ] localStorage 에러 핸들링 (용량 초과 등)

- [ ] Task 2: 자동 저장 훅(Hook) 구현 (AC: 3, 9)
  - [ ] `/hooks/use-auto-save.ts` 생성
  - [ ] `useDebounce` 훅 사용 (1~2초 디바운스)
  - [ ] 입력 변경 감지 → `saveDraft` 호출
  - [ ] 저장 상태 반환 (`isSaving`, `lastSaved`)

- [ ] Task 3: 노트 작성 페이지에 임시 저장 통합 (AC: 1, 4, 5, 7, 9)
  - [ ] `/app/notes/new/page.tsx` 수정
  - [ ] 컴포넌트 마운트 시 임시 저장 데이터 확인
  - [ ] 임시 저장 데이터 불러오기 알림 표시
  - [ ] 자동 저장 훅 적용
  - [ ] 저장 상태 UI 표시 ("임시 저장됨 - 3초 전")
  - [ ] "임시 저장 삭제" 버튼 추가

- [ ] Task 4: 노트 수정 페이지에 임시 저장 통합 (AC: 1, 3, 4, 10)
  - [ ] `/app/notes/[id]/edit/page.tsx`에도 동일 로직 적용
  - [ ] 각 노트별로 고유한 임시 저장 키 사용 (`draft-note-{id}`)

- [ ] Task 5: 페이지 이탈 방지 (AC: 8)
  - [ ] `beforeunload` 이벤트 리스너 추가
  - [ ] 저장하지 않은 변경사항이 있을 때만 경고
  - [ ] "페이지를 벗어나시겠습니까?" 확인 다이얼로그

- [ ] Task 6: 노트 저장 성공 후 임시 저장 삭제 (AC: 6)
  - [ ] 노트 저장 성공 시 `deleteDraft` 호출
  - [ ] 서버 액션 성공 콜백에서 처리

- [ ] Task 7: 테스트 작성
  - [ ] localStorage 유틸리티 함수 테스트
  - [ ] 자동 저장 훅 테스트
  - [ ] 노트 작성 페이지 임시 저장 통합 테스트
  - [ ] 페이지 이탈 방지 테스트

## Dev Notes

### 기술 스택
[Source: docs/architecture.md#1]
- **프레임워크:** Next.js App Router (Client Component)
- **상태 관리:** React Hooks (`useState`, `useEffect`, `useDebounce`)
- **저장소:** Browser `localStorage`
- **UI 컴포넌트:** shadcn/ui + Tailwind CSS

### localStorage 키 구조
```typescript
// 새 노트 작성
const DRAFT_KEY_NEW = 'draft-note-new';

// 기존 노트 수정
const DRAFT_KEY_EDIT = (id: string) => `draft-note-${id}`;

// 저장 데이터 구조
interface DraftData {
  title: string;
  content: string;
  savedAt: number; // timestamp
}
```

### 자동 저장 플로우
1. 사용자가 제목 또는 본문 입력
2. `useDebounce` 훅으로 1~2초 대기
3. `saveDraft` 함수 호출 → `localStorage` 저장
4. 저장 상태 UI 업데이트 ("임시 저장됨 - 방금 전")

### 임시 저장 불러오기 플로우
1. 컴포넌트 마운트 시 `loadDraft` 호출
2. 임시 저장 데이터 확인
3. 있으면 → 폼 필드에 자동 입력 + 알림 표시
4. 없으면 → 정상 플로우

### 페이지 이탈 방지
```typescript
useEffect(() => {
  const handleBeforeUnload = (e: BeforeUnloadEvent) => {
    if (hasUnsavedChanges) {
      e.preventDefault();
      e.returnValue = ''; // Chrome requires returnValue
    }
  };
  window.addEventListener('beforeunload', handleBeforeUnload);
  return () => window.removeEventListener('beforeunload', handleBeforeUnload);
}, [hasUnsavedChanges]);
```

### 프로젝트 구조
[Source: project-rule.mdc]
- localStorage 유틸리티: `/lib/utils/draft-storage.ts`
- 자동 저장 훅: `/hooks/use-auto-save.ts`
- 디바운스 훅: `/hooks/use-debounce.ts` (또는 기존 라이브러리 사용)
- 노트 작성 페이지 수정: `/app/notes/new/page.tsx`
- 노트 수정 페이지 수정: `/app/notes/[id]/edit/page.tsx`

### 저장 상태 UI 예시
```
┌─────────────────────────┐
│  제목: [입력 필드]       │
│  본문: [입력 필드]       │
│                         │
│  ✓ 임시 저장됨 - 3초 전  │  ← 저장 상태 표시
│  [저장] [취소] [초안 삭제]│
└─────────────────────────┘
```

### 주의사항
[Source: project-rule.mdc]
- 모든 파일은 4줄의 헤더 주석으로 시작
- 파일은 500 LOC 이하 유지
- localStorage는 최대 5~10MB 용량 제한 고려
- 민감한 정보는 localStorage에 저장하지 않음
- 여러 탭/브라우저 간 동기화는 고려하지 않음 (단일 탭 기준)

### localStorage 에러 핸들링
```typescript
try {
  localStorage.setItem(key, JSON.stringify(data));
} catch (error) {
  if (error.name === 'QuotaExceededError') {
    console.error('localStorage 용량 초과');
    // 사용자에게 알림 표시
  }
}
```

### 디바운스 타이밍
- **짧은 디바운스 (1초):** 사용자가 입력을 멈추자마자 저장 (반응성 좋음)
- **긴 디바운스 (2~3초):** 저장 빈도 감소 (성능 좋음)
- **권장:** 1.5~2초 (중간 타협점)

### 의존성
[Source: Story 2.2, Story 2.5]
- 노트 생성 페이지가 구현되어 있어야 함 (Story 2.2 완료)
- 노트 수정 페이지가 구현되어 있어야 함 (Story 2.5 완료 또는 진행 중)

### 선택적 개선사항
- 임시 저장 목록 관리 페이지 (`/notes/drafts`)
- 여러 임시 저장 간 전환 기능
- 임시 저장 자동 정리 (7일 이상 경과 시 삭제)
- Cloud 동기화 (향후 로드맵)

### Testing

#### 테스트 파일 위치
- localStorage 유틸리티 테스트: `__tests__/lib/utils/draft-storage.test.ts`
- 자동 저장 훅 테스트: `__tests__/hooks/use-auto-save.test.ts`
- 노트 작성 페이지 테스트: `__tests__/app/notes/new/page.test.tsx` (기존 파일에 추가)

#### 테스트 표준
[Source: project-rule.mdc]
- 테스트 실행: `pnpm test`
- 모든 기능은 단위 테스트 및 통합 테스트 작성 필수

#### 이 스토리의 테스트 요구사항
1. **유틸리티 함수 테스트:**
   - `saveDraft` 정상 작동 확인
   - `loadDraft` 정상 작동 확인
   - `deleteDraft` 정상 작동 확인
   - localStorage 에러 핸들링 확인
   
2. **훅 테스트:**
   - `useAutoSave` 디바운스 작동 확인
   - 저장 상태 반환 확인
   
3. **통합 테스트:**
   - 노트 작성 중 자동 저장 확인
   - 페이지 재방문 시 임시 저장 불러오기 확인
   - 노트 저장 성공 후 임시 저장 삭제 확인
   - 페이지 이탈 방지 확인
   
4. **엣지 케이스 테스트:**
   - localStorage 비활성화 상황
   - localStorage 용량 초과 상황

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-14 | 1.0 | 스토리 초안 생성 | SM-Bob |

## Dev Agent Record

### Agent Model Used
_개발 시 자동 기록_

### Debug Log References
_개발 시 자동 기록_

### Completion Notes List
_개발 시 자동 기록_

### File List
_개발 시 자동 기록_

---

<!-- Powered by BMAD™ Core -->

