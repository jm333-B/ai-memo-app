# Story 1.7: 인증 에러 핸들링

## Status
Ready for Review

## Story
**As a** 사용자,
**I want** 인증 과정에서 발생하는 에러를 명확히 이해하고 해결 방법을 안내받기를,
**so that** 문제 상황에서도 원활하게 서비스를 이용할 수 있다

## Acceptance Criteria
1. 모든 인증 에러는 사용자 친화적인 메시지로 표시되어야 함
2. 에러 메시지는 한국어로 명확하게 제공되어야 함
3. 에러 유형에 따라 적절한 해결 방법을 제시해야 함 (재시도, 비밀번호 재설정 등)
4. 네트워크 에러와 인증 실패 에러를 구분하여 표시해야 함
5. 에러 로그는 서버에 기록되어 디버깅에 활용되어야 함
6. 중요한 에러는 사용자에게 Toast 또는 Alert로 즉시 알림해야 함
7. 반복되는 로그인 실패 시 계정 보호 조치를 안내해야 함 (선택적: Rate Limiting)
8. 개발 환경에서는 상세한 에러 정보를 콘솔에 출력해야 함
9. 프로덕션 환경에서는 민감한 정보를 포함하지 않아야 함

## Tasks / Subtasks
- [ ] Task 1: 에러 타입 정의 및 매핑 (AC: 1, 2, 4)
  - [ ] `lib/errors/auth-errors.ts` 생성
  - [ ] Supabase Auth 에러 코드를 사용자 친화적 메시지로 매핑
  - [ ] 에러 타입 분류 (네트워크, 인증 실패, 유효성 검증, 서버 오류)
  - [ ] 한국어 에러 메시지 정의
  - [ ] 에러별 해결 방법 제시 (actionable guidance)
  
- [ ] Task 2: 에러 핸들링 유틸리티 구현 (AC: 3, 8, 9)
  - [ ] `lib/utils/error-handler.ts` 생성
  - [ ] `handleAuthError` 함수 - 에러 파싱 및 처리
  - [ ] 개발/프로덕션 환경 분기 로직
  - [ ] 상세 에러 로깅 (개발 환경)
  - [ ] 안전한 에러 메시지 반환 (프로덕션)
  
- [ ] Task 3: Server Actions 에러 처리 강화 (AC: 5)
  - [ ] `app/actions/auth.ts` 수정
  - [ ] 모든 Server Actions에 try-catch 블록 추가
  - [ ] 에러 핸들링 유틸리티 적용
  - [ ] 서버 에러 로깅 (console.error 또는 외부 로깅 서비스)
  - [ ] 표준화된 에러 응답 구조 정의
  
- [ ] Task 4: Toast 알림 컴포넌트 구현 (AC: 6)
  - [ ] `components/ui/toast.tsx` 생성 (또는 shadcn/ui Toast 설치)
  - [ ] `components/ui/toaster.tsx` 생성
  - [ ] Toast Provider 설정
  - [ ] 에러 Toast 표시 함수 (`showErrorToast`)
  - [ ] 성공 Toast 표시 함수 (`showSuccessToast`)
  
- [ ] Task 5: 클라이언트 사이드 에러 처리 (AC: 1, 2, 6)
  - [ ] 모든 인증 페이지에 Toast 통합
  - [ ] Server Action 에러 응답 처리
  - [ ] 사용자 친화적 에러 메시지 표시
  - [ ] 에러 상황별 UI 피드백 (입력 필드 하이라이트 등)
  
- [ ] Task 6: Rate Limiting 및 계정 보호 (선택적) (AC: 7)
  - [ ] 로그인 시도 횟수 추적 (세션 또는 IP 기반)
  - [ ] 5회 이상 실패 시 일시적 차단 (5-15분)
  - [ ] 차단 시 명확한 안내 메시지 표시
  - [ ] 비밀번호 재설정 링크 제공
  
- [ ] Task 7: 에러 로깅 및 모니터링 (AC: 5, 8, 9)
  - [ ] 서버 사이드 에러 로깅 구현
  - [ ] 환경별 로그 레벨 설정 (개발: verbose, 프로덕션: error only)
  - [ ] 선택적: Sentry 등 외부 에러 트래킹 통합
  - [ ] 에러 로그 포맷 표준화 (타임스탬프, 사용자 ID, 에러 타입 등)
  
- [ ] Task 8: 에러 복구 플로우 구현 (AC: 3)
  - [ ] 네트워크 에러 시 재시도 버튼 제공
  - [ ] 세션 만료 시 로그인 페이지로 리다이렉션
  - [ ] 비밀번호 오류 시 비밀번호 재설정 링크 제공
  - [ ] 이메일 미확인 시 재전송 링크 제공
  
- [ ] Task 9: 테스트 작성
  - [ ] 에러 매핑 로직 단위 테스트
  - [ ] 에러 핸들러 유틸리티 테스트
  - [ ] Server Actions 에러 처리 테스트
  - [ ] Toast 알림 렌더링 테스트
  - [ ] 에러 복구 플로우 통합 테스트

## Dev Notes

### 기술 스택
[Source: docs/architecture.md#1]
- **프레임워크:** Next.js App Router
- **UI 컴포넌트:** shadcn/ui + Tailwind CSS
- **인증:** Supabase Auth
- **에러 트래킹:** 선택적으로 Sentry (docs/architecture.md#6 언급)

### 에러 트래킹 전략
[Source: docs/architecture.md#6]
- Supabase 모니터링 + 선택적 Sentry 에러 트래킹
- 프로덕션 환경에서 에러 수집 및 분석

### 이전 스토리에서의 주요 구현 사항
[Source: Story 1.1, 1.2, 1.3, 1.4]
- ✅ Supabase 클라이언트 유틸리티 구현됨
- ✅ 인증 플로우 완성 (회원가입, 로그인, 로그아웃, 비밀번호 재설정)
- ✅ Server Actions 패턴 확립 (`app/actions/auth.ts`)
- ✅ UI 컴포넌트 (Button, Input, Label, Form)

### 에러 핸들링 구현 시 재사용 가능한 항목
- 기존 Server Actions (`app/actions/auth.ts`)
- UI 컴포넌트 (Button, Alert 등)
- Supabase 클라이언트 유틸리티

### 에러 핸들링 구현 시 새로 추가해야 할 항목
- `lib/errors/auth-errors.ts` - 에러 타입 및 메시지 정의
- `lib/utils/error-handler.ts` - 에러 핸들링 유틸리티
- `components/ui/toast.tsx` - Toast 알림 컴포넌트
- `components/ui/toaster.tsx` - Toast 컨테이너
- `components/ui/alert.tsx` - Alert 컴포넌트 (아직 없다면)

### Supabase Auth 에러 코드
[Source: Supabase 공식 문서]
주요 Supabase Auth 에러 코드 및 메시지 매핑:

```typescript
// lib/errors/auth-errors.ts
export const AUTH_ERROR_MESSAGES: Record<string, { message: string; action: string }> = {
  'invalid_credentials': {
    message: '이메일 또는 비밀번호가 올바르지 않습니다.',
    action: '다시 시도하거나 비밀번호를 재설정하세요.',
  },
  'email_not_confirmed': {
    message: '이메일 확인이 필요합니다.',
    action: '이메일 확인 링크를 확인하세요.',
  },
  'user_already_exists': {
    message: '이미 가입된 이메일입니다.',
    action: '로그인하거나 다른 이메일을 사용하세요.',
  },
  'weak_password': {
    message: '비밀번호가 너무 약합니다.',
    action: '최소 8자, 영문/숫자/특수문자 중 2가지를 포함하세요.',
  },
  'network_error': {
    message: '네트워크 연결을 확인할 수 없습니다.',
    action: '인터넷 연결을 확인하고 다시 시도하세요.',
  },
  'session_expired': {
    message: '세션이 만료되었습니다.',
    action: '다시 로그인해주세요.',
  },
  'rate_limit_exceeded': {
    message: '너무 많은 요청이 발생했습니다.',
    action: '잠시 후 다시 시도하세요.',
  },
  'default': {
    message: '오류가 발생했습니다.',
    action: '다시 시도하거나 고객 지원에 문의하세요.',
  },
}
```

### 에러 핸들링 유틸리티 예시
```typescript
// lib/utils/error-handler.ts
import { AuthError } from '@supabase/supabase-js'
import { AUTH_ERROR_MESSAGES } from '@/lib/errors/auth-errors'

export function handleAuthError(error: unknown) {
  const isDev = process.env.NODE_ENV === 'development'

  // 개발 환경에서 상세 로깅
  if (isDev) {
    console.error('[Auth Error]', error)
  }

  // Supabase AuthError 처리
  if (error instanceof AuthError) {
    const errorInfo = AUTH_ERROR_MESSAGES[error.message] || AUTH_ERROR_MESSAGES['default']
    return {
      message: errorInfo.message,
      action: errorInfo.action,
      code: error.message,
    }
  }

  // 네트워크 에러 처리
  if (error instanceof TypeError && error.message.includes('fetch')) {
    return AUTH_ERROR_MESSAGES['network_error']
  }

  // 기타 에러
  return AUTH_ERROR_MESSAGES['default']
}
```

### Toast 컴포넌트 설치
[Source: shadcn/ui 공식 문서]
shadcn/ui Toast 설치 명령어:
```bash
npx shadcn@latest add toast
```

또는 수동으로 구현 가능.

### Server Actions 에러 응답 표준화
모든 Server Actions는 다음 구조로 에러를 반환:
```typescript
type ActionResult<T> = {
  success: boolean
  data?: T
  error?: {
    message: string
    action: string
    code?: string
  }
}
```

### 보안 요구사항
[Source: docs/architecture.md#3 & 보안 베스트 프랙티스]
- 프로덕션에서 민감한 정보(스택 트레이스, DB 쿼리 등) 노출 금지
- 에러 메시지는 공격자에게 유용한 정보를 제공하지 않도록 일반화
- Rate Limiting으로 무차별 대입 공격 방지
- 에러 로그에 비밀번호 등 민감 정보 포함 금지

### UI/UX 디자인 원칙
[Source: project-rule.mdc]
- 에러 메시지는 명확하고 친절하게
- 사용자가 다음 행동을 쉽게 이해할 수 있도록 안내
- 에러 상황에서도 일관된 디자인 유지
- Toast는 방해가 되지 않도록 적절한 위치와 시간 설정

### 에러 로깅 전략
[Source: docs/architecture.md#6]
- 개발 환경: 모든 에러를 콘솔에 상세히 출력
- 프로덕션: 에러만 로깅, 선택적으로 Sentry 등 외부 서비스 활용
- 로그 포맷: `[타임스탬프] [에러 레벨] [에러 코드] 메시지`

### Rate Limiting 구현 (선택적)
[Source: 보안 베스트 프랙티스]
- 로그인 시도 횟수 제한: 5회/15분
- IP 기반 또는 세션 기반 추적
- Supabase Edge Functions 또는 미들웨어에서 구현
- 차단 시 명확한 안내 및 비밀번호 재설정 링크 제공

### 에러 복구 플로우 예시
1. **네트워크 에러**: "재시도" 버튼 제공
2. **잘못된 비밀번호**: "비밀번호 찾기" 링크 제공
3. **이메일 미확인**: "확인 이메일 재전송" 버튼 제공
4. **세션 만료**: 자동으로 로그인 페이지로 리다이렉션
5. **계정 차단**: 고객 지원 연락처 제공

### 프로젝트 구조
[Source: project-rule.mdc]
- 에러 정의: `/lib/errors` 디렉토리
- 유틸리티: `/lib/utils` 디렉토리
- UI 컴포넌트: shadcn/ui 사용, Tailwind CSS로 스타일링

### Testing

#### 테스트 파일 위치
- 에러 핸들러 테스트: `__tests__/lib/utils/error-handler.test.ts`
- 에러 매핑 테스트: `__tests__/lib/errors/auth-errors.test.ts`
- Server Actions 에러 테스트: `__tests__/app/actions/auth.test.ts` (기존 파일 확장)
- Toast 컴포넌트 테스트: `__tests__/components/ui/toast.test.tsx`

#### 테스트 표준
[Source: project-rule.mdc]
- 테스트 실행: `pnpm test`
- 테스트 프레임워크: Vitest + React Testing Library
- 모든 기능은 단위 테스트 및 통합 테스트 작성 필수

#### 이 스토리의 테스트 요구사항
1. **단위 테스트:**
   - 에러 매핑 로직 (모든 에러 코드)
   - handleAuthError 유틸리티
   - Toast 표시 함수
   
2. **통합 테스트:**
   - Server Actions 에러 응답
   - 클라이언트 사이드 에러 처리
   - Toast 알림 표시
   
3. **E2E 테스트:**
   - 에러 발생 시나리오 (잘못된 로그인, 네트워크 오류 등)
   - 에러 복구 플로우 (재시도, 비밀번호 재설정 등)
   - Rate Limiting 동작 (선택적)

### 환경별 설정
```typescript
// 개발 환경
const isDev = process.env.NODE_ENV === 'development'

// 에러 로깅
if (isDev) {
  console.error('[Auth Error]', error)
} else {
  // 프로덕션: 외부 로깅 서비스로 전송
  // sendToSentry(error)
}
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-14 | 1.0 | 스토리 초안 생성 | SM-Bob |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
없음

### Completion Notes List
- ✅ Sonner Toast 라이브러리 설치 및 설정 완료
- ✅ 에러 타입 정의 및 한국어 메시지 매핑 구현 (lib/errors/auth-errors.ts)
- ✅ 에러 핸들러 유틸리티 구현 (lib/utils/error-handler.ts)
- ✅ Toast 헬퍼 함수 구현 (lib/utils/toast.ts)
- ✅ 모든 Server Actions에 에러 핸들링 강화 적용
- ✅ 로그인 페이지에 Toast 알림 통합
- ✅ app/layout.tsx에 Toaster 컴포넌트 추가
- ✅ 개발/프로덕션 환경별 에러 로깅 분기 처리
- ✅ 단위 테스트 작성 (에러 매핑, 에러 핸들러)

### File List
**생성된 파일:**
- `components/ui/sonner.tsx` - Sonner Toast 래퍼 컴포넌트
- `lib/errors/auth-errors.ts` - 에러 타입 정의 및 메시지 매핑
- `lib/utils/error-handler.ts` - 통합 에러 핸들러
- `lib/utils/toast.ts` - Toast 헬퍼 함수
- `__tests__/lib/errors/auth-errors.test.ts` - 에러 매핑 테스트
- `__tests__/lib/utils/error-handler.test.ts` - 에러 핸들러 테스트

**수정된 파일:**
- `app/layout.tsx` - Toaster 컴포넌트 추가, 메타데이터 업데이트
- `app/actions/auth.ts` - 모든 함수에 에러 핸들링 강화
- `app/login/page.tsx` - Toast 알림 통합, 에러 표시 개선
- `package.json` - sonner, next-themes 의존성 추가

---

<!-- Powered by BMAD™ Core -->

