# Story 2.1: Drizzle ORM 환경 세팅 및 Notes 스키마 구성

## Status
Ready for Review

## Story
**As a** 개발자,
**I want** Drizzle ORM을 프로젝트에 설정하고 노트 관리를 위한 데이터베이스 스키마를 구성하고 싶다,
**so that** 안정적이고 타입 안전한 방식으로 노트 데이터를 저장하고 관리할 수 있다

## Acceptance Criteria
1. Drizzle ORM 및 관련 패키지가 프로젝트에 설치되어야 함
2. Drizzle 설정 파일(`drizzle.config.ts`)이 Supabase Postgres 연결을 위해 올바르게 구성되어야 함
3. `notes` 테이블 스키마가 `/drizzle/schema.ts`에 정의되어야 함 (id, user_id, title, content, created_at, updated_at)
4. Drizzle Kit을 통한 마이그레이션 파일이 생성되어야 함
5. 마이그레이션이 Supabase 데이터베이스에 성공적으로 적용되어야 함
6. Drizzle 클라이언트 인스턴스가 생성되고 재사용 가능하도록 구성되어야 함
7. `package.json`에 Drizzle 관련 스크립트가 추가되어야 함 (generate, migrate, push, studio)
8. 스키마 변경 사항이 타입스크립트 타입으로 자동 반영되어야 함

## Tasks / Subtasks
- [x] Task 1: Drizzle ORM 패키지 설치 (AC: 1)
  - [x] `drizzle-orm`, `drizzle-kit` 설치
  - [x] Postgres 드라이버 설치 (`postgres` 또는 `@supabase/supabase-js`)
  - [x] 타입 정의 패키지 설치 (필요 시)
  
- [x] Task 2: Drizzle 설정 파일 구성 (AC: 2, 7)
  - [x] `drizzle.config.ts` 생성 및 Supabase 연결 문자열 설정
  - [x] 스키마 파일 경로 설정 (`/drizzle/schema.ts`)
  - [x] 마이그레이션 출력 디렉토리 설정 (`/drizzle/migrations`)
  - [x] `package.json`에 Drizzle Kit 스크립트 추가
  
- [x] Task 3: Notes 테이블 스키마 정의 (AC: 3, 8)
  - [x] `/drizzle/schema.ts` 파일 생성
  - [x] `notes` 테이블 스키마 정의:
    - `id` (UUID, 기본 키, 자동 생성)
    - `user_id` (UUID, 외래 키, NOT NULL)
    - `title` (TEXT, NOT NULL)
    - `content` (TEXT, NOT NULL)
    - `created_at` (TIMESTAMP, 기본값: now())
    - `updated_at` (TIMESTAMP, 기본값: now())
  - [x] 인덱스 정의 (user_id, created_at)
  
- [x] Task 4: 마이그레이션 생성 및 적용 (AC: 4, 5)
  - [x] `pnpm drizzle-kit:generate` 실행하여 마이그레이션 파일 생성
  - [x] 생성된 마이그레이션 파일 검토
  - [x] `pnpm drizzle-kit:push` 또는 `migrate` 실행하여 DB에 적용
  - [x] Supabase Studio에서 테이블 생성 확인
  
- [x] Task 5: Drizzle 클라이언트 인스턴스 생성 (AC: 6)
  - [x] `/lib/db/index.ts` 또는 `/lib/drizzle.ts` 생성
  - [x] Supabase 연결을 사용하는 Drizzle 클라이언트 설정
  - [x] 스키마 import 및 타입 export
  
- [x] Task 6: 테스트 작성
  - [x] Drizzle 클라이언트 연결 테스트
  - [x] 스키마 타입 검증 테스트
  - [x] 기본 CRUD 작동 확인 테스트

## Dev Notes

### 기술 스택
[Source: docs/architecture.md#1]
- **ORM:** Drizzle ORM
- **데이터베이스:** Supabase Postgres
- **프레임워크:** Next.js App Router

### 데이터 모델
[Source: docs/architecture.md#2]
- **notes 테이블:**
  - id, user_id, title, content, created_at, updated_at
- 모든 테이블은 `/drizzle/schema.ts`의 Drizzle Schema로 정의
- 마이그레이션은 Drizzle Kit으로 실행

### 보안 요구사항
[Source: docs/architecture.md#3]
- 권한 스코프는 서버 코드에서 처리
- 모든 Drizzle 쿼리는 사용자 스코프를 WHERE로 직접 강제
- `user_id`는 Supabase Auth의 사용자 ID와 연동

### Drizzle 명령어
[Source: project-rule.mdc]
```bash
pnpm drizzle-kit generate    # 마이그레이션 파일 생성
pnpm drizzle-kit migrate     # 마이그레이션 적용
pnpm drizzle-kit push        # 스키마 DB에 반영
pnpm drizzle-kit pull        # DB 스키마 가져오기
pnpm drizzle-kit check       # 마이그레이션 충돌 검사
pnpm drizzle-kit studio      # Drizzle Studio 실행
```

### 환경 변수
Supabase 데이터베이스 연결을 위한 환경 변수:
```
DATABASE_URL=postgresql://[user]:[password]@[host]:[port]/[database]
```
또는 Supabase 연결 풀링 URL 사용

### 파일 생성 위치
- Drizzle 설정: `/drizzle.config.ts`
- 스키마 정의: `/drizzle/schema.ts`
- 마이그레이션 파일: `/drizzle/migrations/`
- Drizzle 클라이언트: `/lib/db/index.ts` 또는 `/lib/drizzle.ts`

### 주의사항
[Source: project-rule.mdc]
- 모든 파일은 4줄의 헤더 주석으로 시작
- 파일은 500 LOC 이하 유지
- DB 관련 제안은 가능하되 직접 실행은 사용자가 수행

### Testing

#### 테스트 파일 위치
- Drizzle 클라이언트 테스트: `__tests__/lib/db/` 또는 `__tests__/lib/drizzle.test.ts`
- 스키마 테스트: `__tests__/drizzle/schema.test.ts`

#### 테스트 표준
[Source: project-rule.mdc]
- 테스트 실행: `pnpm test`
- 모든 기능은 단위 테스트 작성 필수

#### 이 스토리의 테스트 요구사항
1. **연결 테스트:**
   - Drizzle 클라이언트가 정상적으로 초기화되는지 확인
   - 데이터베이스 연결이 유효한지 확인
   
2. **스키마 테스트:**
   - Notes 테이블 스키마 타입이 올바르게 정의되었는지 확인
   - 필수 필드가 모두 존재하는지 확인
   
3. **기본 CRUD 테스트:**
   - 간단한 노트 생성 테스트 (insert)
   - 노트 조회 테스트 (select)
   - 테스트 데이터 정리

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-14 | 1.0 | 스토리 초안 생성 | PO-Sarah |
| 2025-10-14 | 1.1 | 스토리 구현 진행 중 (Task 4 제외 완료) | Dev-James |
| 2025-10-14 | 2.0 | 스토리 구현 완료 | Dev-James |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
없음

### Completion Notes List
- ✅ Drizzle ORM 및 관련 패키지 설치 완료 (drizzle-orm v0.44.6, drizzle-kit v0.31.5, postgres v3.4.7)
- ✅ dotenv 패키지 추가하여 환경 변수 로딩 개선
- ✅ Drizzle 설정 파일 생성 완료 (drizzle.config.ts with dotenv)
- ✅ package.json에 Drizzle Kit 스크립트 추가 (generate, migrate, push, pull, check, up, studio)
- ✅ Notes 테이블 스키마 정의 완료 (id, user_id, title, content, created_at, updated_at)
- ✅ 인덱스 설정 완료 (notes_user_id_idx, notes_created_at_idx)
- ✅ Drizzle 클라이언트 인스턴스 생성 완료 (lib/db/index.ts)
- ✅ 타입 안전성 확보를 위한 타입 export 완료 (Note, NewNote)
- ✅ DATABASE_URL 환경 변수 설정 완료 (특수문자 URL 인코딩 처리)
- ✅ 마이그레이션 파일 생성 완료 (drizzle/migrations/0000_lumpy_punisher.sql)
- ✅ 데이터베이스 스키마 적용 완료 (pnpm drizzle-kit:push)
- ✅ Supabase 데이터베이스에 notes 테이블 생성 확인
- ✅ 테스트 환경 설정 완료 (vitest.setup.ts에 dotenv 추가)
- ✅ 테스트 코드 수정 완료 (UUID 타입 사용)
- ✅ 모든 테스트 통과 (10/10 tests passed)

**🔧 해결한 이슈:**
1. DATABASE_URL의 특수문자 `##` → `%23%23`로 URL 인코딩 처리
2. Vitest 테스트 환경에서 환경 변수 로드 설정
3. 테스트에서 UUID 타입 사용 (crypto.randomUUID())

### File List
**생성된 파일:**
- `drizzle.config.ts` - Drizzle Kit 설정 파일 (dotenv 포함)
- `drizzle/schema.ts` - Notes 테이블 스키마 정의
- `drizzle/migrations/0000_lumpy_punisher.sql` - 마이그레이션 파일
- `drizzle/migrations/meta/_journal.json` - 마이그레이션 저널
- `drizzle/migrations/meta/0000_snapshot.json` - 마이그레이션 스냅샷
- `lib/db/index.ts` - Drizzle 클라이언트 인스턴스
- `__tests__/lib/db/index.test.ts` - Drizzle 클라이언트 테스트
- `__tests__/drizzle/schema.test.ts` - 스키마 타입 검증 테스트

**수정된 파일:**
- `package.json` - Drizzle 관련 패키지 및 스크립트 추가 (dotenv, drizzle-orm, drizzle-kit, postgres)
- `.env.local` - DATABASE_URL 설정 및 특수문자 URL 인코딩
- `vitest.setup.ts` - dotenv 설정 추가

---

<!-- Powered by BMAD™ Core -->

