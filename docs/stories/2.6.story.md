# Story 2.6: 노트 삭제 및 복구

## Status
Ready for Review

## Story
**As a** 로그인한 사용자,
**I want** 더 이상 필요하지 않은 노트를 삭제하고, 실수로 삭제한 경우 복구할 수 있기를 원한다,
**so that** 노트 목록을 깔끔하게 유지하면서도 중요한 노트를 실수로 잃어버리지 않을 수 있다

## Acceptance Criteria
1. 노트 상세 페이지에서 "삭제" 버튼을 클릭할 수 있어야 함
2. 삭제 버튼 클릭 시 확인 다이얼로그가 표시되어야 함
3. 확인 다이얼로그에서 "취소" 선택 시 아무 일도 일어나지 않아야 함
4. 확인 다이얼로그에서 "삭제" 확인 시 노트가 삭제되어야 함
5. 노트 삭제는 소프트 삭제(Soft Delete) 방식을 사용해야 함
6. 삭제된 노트는 일반 노트 목록에서 보이지 않아야 함
7. 삭제 성공 시 노트 목록 페이지로 리다이렉션되어야 함
8. 삭제 성공 시 성공 메시지를 표시해야 함 (토스트 또는 알림)
9. 현재 로그인한 사용자의 노트만 삭제 가능해야 함 (권한 검증)
10. 다른 사용자의 노트 삭제 시도 시 403 에러 또는 권한 없음 메시지를 표시해야 함
11. (선택적) 삭제된 노트 목록 페이지(`/notes/trash`)를 제공해야 함
12. (선택적) 휴지통에서 노트를 복구할 수 있어야 함
13. (선택적) 휴지통에서 노트를 영구 삭제할 수 있어야 함
14. (선택적) 삭제된 지 30일이 지난 노트는 자동으로 영구 삭제되어야 함

## Tasks / Subtasks
- [ ] Task 1: 데이터베이스 스키마 수정 (AC: 5)
  - [ ] `drizzle/schema.ts`에 `deleted_at` 컬럼 추가 (TIMESTAMP, nullable)
  - [ ] 마이그레이션 파일 생성 (`pnpm drizzle-kit:generate`)
  - [ ] 마이그레이션 실행 (`pnpm drizzle-kit:push`)

- [ ] Task 2: Server Action으로 노트 삭제 로직 구현 (AC: 4, 5, 9)
  - [ ] `/app/actions/notes.ts`에 `deleteNote` Server Action 추가
  - [ ] Supabase Auth를 통해 현재 사용자 ID 가져오기
  - [ ] 권한 검증: 삭제하려는 노트의 소유자인지 확인
  - [ ] Drizzle ORM을 사용하여 `deleted_at` 필드 업데이트 (현재 시간)
  - [ ] 에러 핸들링 및 에러 메시지 반환

- [ ] Task 3: 노트 목록 조회 수정 (AC: 6)
  - [ ] `getNotes` Server Action 수정
  - [ ] WHERE 절에 `deleted_at IS NULL` 조건 추가
  - [ ] 삭제된 노트는 목록에서 제외

- [ ] Task 4: 삭제 UI 구현 (AC: 1, 2, 3, 7, 8)
  - [ ] 노트 상세 페이지에 삭제 버튼 추가
  - [ ] shadcn/ui AlertDialog 컴포넌트 사용
  - [ ] 확인 다이얼로그 구현 ("정말 삭제하시겠습니까?")
  - [ ] 삭제 성공 시 `/notes`로 리다이렉션
  - [ ] 성공 메시지 토스트 표시 (선택적)

- [ ] Task 5: 권한 검증 및 에러 처리 (AC: 10)
  - [ ] 노트 소유자가 아닌 경우 에러 반환
  - [ ] 존재하지 않는 노트 처리
  - [ ] 403 Forbidden 에러 메시지 표시

- [ ] Task 6: (선택적) 휴지통 페이지 구현 (AC: 11)
  - [ ] `/app/notes/trash/page.tsx` 생성
  - [ ] `getDeletedNotes` Server Action 추가
  - [ ] WHERE 절에 `deleted_at IS NOT NULL` 조건 추가
  - [ ] 삭제된 노트 목록 표시 (삭제 날짜 포함)

- [ ] Task 7: (선택적) 노트 복구 기능 구현 (AC: 12)
  - [ ] `/app/actions/notes.ts`에 `restoreNote` Server Action 추가
  - [ ] `deleted_at` 필드를 NULL로 업데이트
  - [ ] 휴지통 페이지에 "복구" 버튼 추가
  - [ ] 복구 성공 시 노트 목록 페이지로 리다이렉션

- [ ] Task 8: (선택적) 영구 삭제 기능 구현 (AC: 13)
  - [ ] `/app/actions/notes.ts`에 `permanentlyDeleteNote` Server Action 추가
  - [ ] Drizzle ORM DELETE 쿼리로 노트 영구 삭제
  - [ ] 확인 다이얼로그 구현 ("영구 삭제 시 복구 불가")
  - [ ] 휴지통 페이지에 "영구 삭제" 버튼 추가

- [ ] Task 9: (선택적) 자동 영구 삭제 크론 작업 구현 (AC: 14)
  - [ ] `/app/api/cron/cleanup-trash/route.ts` 생성
  - [ ] 30일 이상 지난 삭제된 노트 조회
  - [ ] WHERE 절: `deleted_at < NOW() - INTERVAL '30 days'`
  - [ ] Drizzle ORM DELETE 쿼리로 영구 삭제
  - [ ] Vercel Cron Jobs 또는 다른 스케줄러 설정

- [ ] Task 10: 테스트 작성
  - [ ] 삭제 버튼 렌더링 테스트
  - [ ] 확인 다이얼로그 동작 테스트
  - [ ] `deleteNote` Server Action 단위 테스트
  - [ ] 권한 검증 테스트
  - [ ] 소프트 삭제 검증 테스트
  - [ ] (선택적) `restoreNote` 테스트
  - [ ] (선택적) `permanentlyDeleteNote` 테스트

## Dev Notes

### 기술 스택
[Source: docs/architecture.md#1]
- **프레임워크:** Next.js App Router
- **UI 컴포넌트:** shadcn/ui + Tailwind CSS (AlertDialog)
- **ORM:** Drizzle ORM
- **인증:** Supabase Auth
- **(선택적) 크론 작업:** Vercel Cron Jobs

### 데이터 모델 변경
[Source: docs/architecture.md#2, Story 2.1]
- **notes 테이블:**
  - `id` (UUID, 기본 키)
  - `user_id` (UUID, NOT NULL)
  - `title` (TEXT, NOT NULL)
  - `content` (TEXT, NOT NULL)
  - `created_at` (TIMESTAMP)
  - `updated_at` (TIMESTAMP)
  - **`deleted_at` (TIMESTAMP, nullable)** - 새로 추가

### 소프트 삭제 (Soft Delete)
- **개념:** 실제로 데이터를 삭제하지 않고 `deleted_at` 필드에 삭제 시간을 기록
- **장점:**
  - 실수로 삭제한 데이터 복구 가능
  - 데이터 보존 및 감사(Audit) 목적
  - 사용자 경험 개선 (실수 방지)
- **단점:**
  - 저장 공간 증가
  - 쿼리 복잡도 증가 (WHERE deleted_at IS NULL)

### 서버 액션
[Source: docs/architecture.md#4]
- `deleteNote` – 노트 소프트 삭제 (이 스토리에서 구현)
- `getDeletedNotes` – 삭제된 노트 목록 조회 (선택적)
- `restoreNote` – 노트 복구 (선택적)
- `permanentlyDeleteNote` – 노트 영구 삭제 (선택적)
- Server Action은 `/app/actions/notes.ts`에 위치

### 보안 요구사항
[Source: docs/architecture.md#3]
- 노트는 현재 로그인한 사용자의 것만 삭제 가능
- 삭제 전 반드시 소유자 확인 (WHERE id = ? AND user_id = ?)
- 권한이 없는 삭제 시도는 차단

### UI/UX 디자인 원칙
[Source: project-rule.mdc]
- 단순하고 깔끔하며 미니멀한 UI
- 삭제 확인 다이얼로그는 명확한 경고 메시지 포함
- 휴지통 UI는 일반 노트 목록과 구분되는 스타일

### shadcn/ui AlertDialog
- **설치:** `npx shadcn@latest add alert-dialog`
- **용도:** 삭제 확인 다이얼로그
- **구성:**
  - AlertDialogTrigger: 삭제 버튼
  - AlertDialogContent: 다이얼로그 본문
  - AlertDialogHeader: 제목
  - AlertDialogDescription: 설명 메시지
  - AlertDialogFooter: 취소/확인 버튼

### 프로젝트 구조
[Source: project-rule.mdc]
- 라우팅: `/app` 디렉토리 사용 (Next.js App Router)
- Server Actions: `/app/actions` 디렉토리
- API 라우트 (크론): `/app/api/cron` 디렉토리

### 파일 생성 위치
- Server Actions: `/app/actions/notes.ts` (기존 파일에 추가)
- 휴지통 페이지: `/app/notes/trash/page.tsx` (선택적)
- 크론 작업: `/app/api/cron/cleanup-trash/route.ts` (선택적)
- 마이그레이션: `drizzle/migrations/XXXX_add_deleted_at.sql` (자동 생성)

### 주의사항
[Source: project-rule.mdc]
- 모든 파일은 4줄의 헤더 주석으로 시작
- 파일은 500 LOC 이하 유지
- 삭제 확인 다이얼로그는 명확한 경고 메시지 필수
- 영구 삭제는 복구 불가능함을 명시

### 의존성
[Source: Story 2.1, Story 2.4]
- Drizzle ORM 환경이 구성되어 있어야 함 (Story 2.1 완료)
- `lib/db/index.ts`의 Drizzle 클라이언트 사용
- `drizzle/schema.ts`의 notes 테이블 스키마 사용
- 노트 상세 조회 기능 필요 (Story 2.4 선행 권장)

### 크론 작업 설정 (선택적)
[Source: Vercel Cron Jobs]
- **설정 파일:** `vercel.json`
- **예시:**
  ```json
  {
    "crons": [
      {
        "path": "/api/cron/cleanup-trash",
        "schedule": "0 0 * * *"
      }
    ]
  }
  ```
- **스케줄:** 매일 자정 (0 0 * * *)
- **보안:** 크론 엔드포인트에 인증 토큰 추가 권장

### Testing

#### 테스트 파일 위치
- Server Action 테스트: `__tests__/app/actions/notes.test.ts` (기존 파일에 추가)
- 휴지통 페이지 테스트: `__tests__/app/notes/trash/page.test.tsx` (선택적)
- 크론 작업 테스트: `__tests__/app/api/cron/cleanup-trash/route.test.ts` (선택적)

#### 테스트 표준
[Source: project-rule.mdc]
- 테스트 실행: `pnpm test`
- 모든 기능은 단위 테스트 및 통합 테스트 작성 필수

#### 이 스토리의 테스트 요구사항
1. **컴포넌트 테스트:**
   - 삭제 버튼 렌더링 확인
   - 확인 다이얼로그 동작
   - 취소 버튼 동작
   
2. **Server Action 테스트:**
   - `deleteNote` 정상 작동 확인 (소프트 삭제)
   - 권한 검증 (소유자만 삭제 가능)
   - `deleted_at` 필드 업데이트 확인
   - 에러 핸들링 시나리오
   
3. **목록 조회 테스트:**
   - `getNotes`가 삭제된 노트를 제외하는지 확인
   - `getDeletedNotes`가 삭제된 노트만 조회하는지 확인 (선택적)
   
4. **복구 테스트 (선택적):**
   - `restoreNote` 정상 작동 확인
   - `deleted_at` 필드가 NULL로 변경되는지 확인
   
5. **영구 삭제 테스트 (선택적):**
   - `permanentlyDeleteNote` 정상 작동 확인
   - 데이터베이스에서 실제로 삭제되는지 확인
   
6. **통합 테스트:**
   - 전체 삭제 플로우 (상세 → 삭제 → 목록)
   - 전체 복구 플로우 (휴지통 → 복구 → 목록)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-14 | 1.0 | 스토리 초안 생성 | SM-Bob |

## Dev Agent Record

### Agent Model Used
_개발 시 자동 기록_

### Debug Log References
_개발 시 자동 기록_

### Completion Notes List
_개발 시 자동 기록_

### File List
_개발 시 자동 기록_

---

<!-- Powered by BMAD™ Core -->

